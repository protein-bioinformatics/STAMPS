<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8"/>
<link rel="stylesheet" type="text/css" href="qsdb.css">
<script src="canvas2svg.js"></script>
<script src="qsdb-functions.js"></script>
<script src="ms-view.js"></script>
<script src="qsdb.js"></script>
<title>QSDB Home</title>
</head>
<body>
<div class="navigation">
    <table width="100%" height=50><tr>
        <td class="navigation_cell" style="font-size: 150%; display: inline; border-width: 0px;">
            <div style="display: inline; font-weight: bold;">Q</div>uality 
            <div style="display: inline; font-weight: bold;">S</div>tandard
            <div style="display: inline; font-weight: bold;">D</div>ata<div style="display: inline; font-weight: bold;">b</div>ase
            <div width="80%" style="display: inline; min-width: 80%;">&nbsp;</div>
        </td>
    
        <td class="navigation_cell_click" align="center" style="border-left: white; border-left-style: solid; border-left-width: 1px;">Feedback</td>
        <td class="navigation_cell_click" align="center">References</td>
        <td class="navigation_cell_click" align="center" onclick="location.href = 'mailto:dominik.kopczynski@isas.de';">Contact</td>
    </tr></table>
</div>


<div style="position:fixed; width:100%; height: 100%; top: 0px;">
    <table width=100% height=100%><tr>
    
        <td width=50% align="center" valign="middle">
        <div width="100%" align="left" style="margin: 20px; text-align: justify;">
            The quality spectra database (QSDB) is web based database designed for easy method development in analytical proteomics. It provides high-quality high-resolution mass spectrometry data for peptides allowing to design assays for SRM or PRM experiments. In combination with <a target="_blank" href="https://skyline.ms">Skyline</a>, a seamless downstream analysis is given.
        </div><br>
        <img src="database-logo.svg"></td>
        <td width=50% height=100% align="center" valign="middle">
            <div style="border-width: 3px; border-color: #999999; border-style: solid; width: 60%; height: 60%; padding-left: 20px; padding-top: 10px; text-align: left; border-radius: 25px; box-shadow: 5px 5px 10px grey; border-collapse: separate;">
                <div style="font-size: 150%;">Overview</div><p>
                <table width=90% cellpadding=10 style="font-size: 120%">
                    <tr><td width=45%>Version:</td><td align="right">v1.0.0</td></tr>
                    <tr><td>Organisms:</td><td align="right">1 (Mouse)</td></tr>
                    <tr><td>Proteins:</td><td align="right">12,216 of 16,802 (72.70%)</td></tr>
                    <tr><td>Proteins in pathways:</td><td align="right">1,241 of 1,670 (74.31%)</td></tr>
                    <tr><td>Unique Peptides:</td><td align="right">121,354</td></tr>
                    <tr><td>Spectra:</td><td align="right">159,013</td></tr>
                </table>
            </div>
        </td>
    </tr></table>
</div>


<div style="position:fixed; width:100%; height: 130px; bottom: 0px;">
    <div id="navigation_startpage" class="navigation_startpage">
    <table height=130>
    <tr><td width="50%">
    </td>
    
    <td style="min-width: 150px; border-left: white; border-left-style: solid; border-left-width: 1px;" id="how_to_nav" class="navigation_cell_click" align="center">
        <img src="how-to-2.svg" height=80><br>
        How&nbsp;To
    </td>
    
    <td style="min-width: 150px;" class="navigation_cell_click" id="pathway_browser_nav" align="center" onclick="location.href = 'browser.html';">
        <img src="pathway-browser-2.svg" height=80><br>
        Pathway&nbsp;Browser
    </td>
    
    <td style="min-width: 150px;" class="navigation_cell_click" id="subcellular_search_nav" align="center" onclick="advanced_search_init(); open_locus_search();">
        <img src="subcellular.svg" height=80><br>
        Subcellular&nbsp;Search
    </td>
    
    <td style="min-width: 150px;" class="navigation_cell_click" id="functional_search_nav" align="center" onclick="advanced_search_init(); open_function_search();">
        <img src="gears.svg" height=80><br>
        Functional&nbsp;Search
    </td>
    
    <td style="min-width: 150px;" class="navigation_cell_click" id="accession_search_nav" align="center" onclick="advanced_search_init(); open_accession_search();">
        <img src="accession-search.svg" height=80><br>
        Accession&nbsp;Search
    </td>
    
    <td style="min-width: 150px;" class="navigation_cell_click" id="chromosome_search_nav" align="center" onclick="advanced_search_init(); open_chromosome_search();">
        <img src="chromosome2.svg" height=80><br>
        Chromosome&nbsp;Search
    </td>
    
    <td style="min-width: 150px;" id="statistics_nav" class="navigation_cell_click" align="center" onclick="open_statistics();">
        <img src="statistics.svg" height=80><br>
        Statistics
    </td>
    
    <td style="min-width: 150px;" id="about_nav" class="navigation_cell_click" align="center" onclick="open_disclaimer();">
        <img src="about.svg" height=80><br>
        About
    </td><td width="50%"></tr>
    </table>
    </div>
</div>


<div id="disclaimer" class="disclaimer" align="justify">
<center><b>About QSDB</b></center><p>
The quality standard database (QSDB) provides a pathway based approach to access proteomics assays for targeted proteomics.
Currently, we are acquiring mass spectra for all proteins within the mouse organism.
Our mass spetrometer is a QExactive Plus or HF, capable to produce high-resolution high-mass accuracy LC-MS/MS spectra.<p>
Responsible people for this database are:<br>
Dominik Kopczynski: Implementation of both front- and backend<br>
Andreas Hentschel: Acquisition and processing of the data<br>
Robert Ahrends: Coordination<p>
The ISAS team is supported by the German network of bioinformatics services (<a href="http://www.denbi.de">de.NBI</a>).
If you have questions, suggestions or other issues, please <a href="mailto:foo@foo.de">contact</a> us.
<p>&nbsp;<p>&nbsp;<p>


<center><b>Disclaimer</b></center><p>
<b>1. Liability limitation</b><br>
Although we acquired our data with highest accurateness, we take no responsibility for the correctness, completeness or up-to-dateness of this data.
The usage of the downloadable data available on this web page takes place at the users own risk.
<p>
 
<b>2. External links</b><br>
This web page contains links forwarding to external web pages.
For all external web pages we disclaim liability.
During the linking no statutory violation was evident.
As soon as a violation emerges, we delete these links.
<p>

<b>3. Copyright</b><br>
The content of this web page is subject to the German copyright law and ancillary copyright.
Every inadmissible utilization defined by the German copyright law and ancillary copyright is forbidden.
This includes the disposal of the downloadable data. 
Download and utilization of the available data for researching purposes is explicitly allowed.
<p>
 
<b>4. Privacy</b><br>
For statistical purposes, we record the number of visits to this web page as well as the number of downloads.
To ensure an unbiased record, we store a hash value of your IP address for several minutes.
Since this method is not reversible, restoring your IP address is not possible, hence this value does not belong to personal-related data.
We do not sell or hand out our collected statistical data to third parties.
<p>
The usage, selling or handing of the contact data written in this imprint is not allowed.
<p>
</div>


<div id="locus_search" class="global_search">
    <table width="100%" height="100%"><tr><td align="center" valign="middle">
        <table cellspacing=20 width="500" class="global_search_content">
            <tr>
                <td>
                    <div id="accession_search_field" style="display: inline;">
                        Select subcellular compartment(s):<br>
                        <select id="loci" size=20 style="width:400px; height:480px;" multiple></select>Hold <b>[ctrl]</b> for multiple selection.
                    </div>
                </td>
            </tr>
            <tr>
                <td id="error_filter_text_locus" style="color: red; font-weight: bold;"></td>
            </tr>
            <tr>
                <td align=right><button onclick="hide_locus_search(false);" style="display: inline;">Cancel</button>&nbsp;<button onclick="check_filter_valid(1);">Next</button>
                </td>
            </tr>
        </table>
    </td></tr></table>
</div>


<div id="function_search" class="global_search">
    <table width="100%" height="100%"><tr><td align="center" valign="middle">
        <table cellspacing=20 width="800" class="global_search_content">
            <tr>
                <td>
                    Select protein function(s):<br>
                    <div id="function_search_field" style="min-width: 700px; width: 700px; min-height: 500px; height: 500px; border-width: 1px; border-color: gray; border-style: solid; overflow-y: scroll;">
                    </div>
                </td>
            </tr>
            <tr>
                <td id="error_filter_text_function" style="color: red; font-weight: bold;">
            </tr>
            <tr>
                <td align=right><button onclick="hide_function_search(false);" style="display: inline;">Cancel</button>&nbsp;<button onclick="check_filter_valid(2);">Next</button>
                </td>
            </tr>
        </table>
    </td></tr></table>
</div>

<div id="accession_search" class="global_search">
    <table width="100%" height="100%"><tr><td align="center" valign="middle">
        <table cellspacing=20 width="500" class="global_search_content">
            <tr>
                <td>
                    <div id="accession_search_field" style="display: inline;">
                        Paste UniProt accession numbers:<br>
                        <textarea id="accessions" style="width:400px; height:500px; font-size: 200%;"></textarea>
                    </div>
                </td>
            </tr>
            <tr>
                <td id="error_filter_text_accession" style="color: red; font-weight: bold;">
                </td>
            </tr>
            <tr>
                <td align="right">
                    <button onclick="hide_accession_search();" style="display: inline;">Cancel</button>&nbsp;<button onclick="check_filter_valid(0);">Next</button>
                </td>
            </tr>
        </table>
    </td></tr></table>
</div>


<div id="chromosome_search" class="disclaimer-90">
    <table width="100%" height="100%">
        <tr>
            <td height="10%" id="chromosome_information" colspan="2" style="border-bottom: 1px solid #000;">Mouse, chromosome  <select onchange="change_chromosome_view_combo();" id="chromosome_selection_combo"></select>, bp: <input type="text" size="7" onkeydown="change_chromosome_view_keydown(event);" onblur="change_chromosome_view();" id="chromosome_selection_start" value="0"></input> - <input type="text" size="7" onkeydown="change_chromosome_view_keydown(event);" onblur="change_chromosome_view();" id="chromosome_selection_end" value="0"></input></td>
        </tr><tr>
            <td width="50%" height="80%" id="function_chromosome_field" style="overflow: hidden;"></td>
            <td>
                <table width="100%" cellpadding="0" cellspacing="0" style="margin: 0px;"><tr><th width="40%">Accession</th><th>Gene name</th><th align="right"><font color="darkblue" size="-2" style="cursor: pointer;" onclick="de_select_all_chromosome_proteins(true);">select all</font><font size="-2"> / </font><font color="darkblue" size="-2" style="cursor: pointer;" onclick="de_select_all_chromosome_proteins(false);">deselect all</font></th></tr></table>
                <div style="height: 500px; overflow-y: auto;" id="chromosome_information_table_wrapper"><div id="chromosome_information_table"></div></div>
            </td>
        </tr>
        <tr>
            <td colspan="2" style="border-top: 1px solid #000;" >
                <table width="100%" cellpadding="0" cellspacing="0">
                    <tr>
                        <td width="70%" id="error_filter_text_chromosome" style="color: red; font-weight: bold;"></td>
                        <td align="right" valign="bottom">
                            <button onclick="hide_chromosome_search(false);" style="display: inline;">Cancel</button>&nbsp;
                            <button onclick="check_filter_valid(3);">Next</button>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</div>

<div id="download" class="download"></div>
<div id="check_spectra" class="check_spectra"></div>
<div id="click_background" class="click_background"></div>
<div id="waiting_background" class="waiting_background"></div>
<div id="statistics" class="disclaimer">
    Still in construction!!!<p>
    <table>
        <tr><td colspan="5">Tissues:</td><td></tr>
        <tr><td><input type="checkbox" id="statistics_check_brain_nsaf" onchange="update_nsaf();" checked /> Brain</td>
            <td><input type="checkbox" id="statistics_check_liver_nsaf" onchange="update_nsaf();" /> Liver</td>
            <td><input type="checkbox" id="statistics_check_kidney_nsaf" onchange="update_nsaf();" /> Kidney</td>
            <td><input type="checkbox" id="statistics_check_spleen_nsaf" onchange="update_nsaf();" /> Spleen</td>
            <td><input type="checkbox" id="statistics_check_heart_nsaf" onchange="update_nsaf();" /> Heart</td>
        </tr>
        <tr><td><input type="checkbox" id="statistics_check_blood_nsaf" onchange="update_nsaf();" /> Plasma</td>
            <td><input type="checkbox" id="statistics_check_fat_nsaf" onchange="update_nsaf();" /> Fat</td>
            <td><input type="checkbox" id="statistics_check_lung_nsaf" onchange="update_nsaf();" /> Lung</td>
            <td><input type="checkbox" id="statistics_check_eye_nsaf" onchange="update_nsaf();" /> Eye</td>
            <td><input type="checkbox" id="statistics_check_gut_nsaf" onchange="update_nsaf();" /> Gut</td>
        </tr>
    </table><br>
    <canvas id="nsaf_figure" width="600" height="300"></canvas>
    <p><hr>
    
    <p>&nbsp;<p>
    <select id="nsaf_pathway_figure_select" onchange="update_nsaf_pathway_figure();"></select><br>
    <canvas id="nsaf_pathway_figure" width="600" height="300"></canvas>
    <p><hr>
    
    <p>&nbsp;<p>
    <table>
        <tr><td colspan="5">Tissues:</td><td></tr>
        <tr><td><input type="checkbox" id="statistics_check_brain_pI" onchange="update_pI();" checked /> Brain</td>
            <td><input type="checkbox" id="statistics_check_liver_pI" onchange="update_pI();" /> Liver</td>
            <td><input type="checkbox" id="statistics_check_kidney_pI" onchange="update_pI();" /> Kidney</td>
            <td><input type="checkbox" id="statistics_check_spleen_pI" onchange="update_pI();" /> Spleen</td>
            <td><input type="checkbox" id="statistics_check_heart_pI" onchange="update_pI();" /> Heart</td>
        </tr>
        <tr><td><input type="checkbox" id="statistics_check_blood_pI" onchange="update_pI();" /> Plasma</td>
            <td><input type="checkbox" id="statistics_check_fat_pI" onchange="update_pI();" /> Fat</td>
            <td><input type="checkbox" id="statistics_check_lung_pI" onchange="update_pI();" /> Lung</td>
            <td><input type="checkbox" id="statistics_check_eye_pI" onchange="update_pI();" /> Eye</td>
            <td><input type="checkbox" id="statistics_check_gut_pI" onchange="update_pI();" /> Gut</td>
        </tr>
    </table><br>
    <canvas id="pI_figure" width="600" height="300"></canvas>
    <p><hr>
    
    <p>&nbsp;<p>
    <select id="ppm_pw_figure_select" onchange="update_ppm();"></select><br>
    <canvas id="ppm_histogram" width="600" height="300"></canvas>
</div>
<audio style="display: none;"><source src="kns.mp3"></source>
</body>
<script>


var chromosomes = {};
var chromosome_keys = [];
var chromosome_map = {};
var chromosome_data = {};
var chromosome_data_dict = {};
var chromosome_selected = -1;
var loaded_chromosomes = 0;
var currently_visible_proteins = [];
var pathways_to_proteins = {};


function Band(data){
    this.arm = data[0];
    this.name = data[1];
    this.start = data[2];
    this.end = data[3];
    this.positive = data[4];
    this.color = data[5];
    this.height = 0;
    
    this.is_mouse_over = function(mouse){
        return false;
    }
    
    this.mouse_click = function(mouse){
        return false;
    }
}


function isNumber(n) {
  return !isNaN(parseInt(n)) && isFinite(n);
}


function change_chromosome_view_keydown(e){
    if(e.keyCode == 13) {
        change_chromosome_view();        
    }
}

var statistics_loaded = 0;
var max_NSAF = -1000000;
var min_NSAF = 0;


function update_nsaf(ctx){
    if (statistics_loaded < 2) return;
    if (typeof(ctx) === 'undefined'){
        var nsaf_figure = document.getElementById("nsaf_figure");
        ctx = nsaf_figure.getContext("2d");
    }
            
    var w_box = 600;
    var w_offset = 50;
    var h_box = 250;
    ctx.clearRect(0, 0, w_box, h_box + w_offset);

    ctx.beginPath();
    ctx.moveTo(w_offset, 0);
    ctx.lineTo(w_box, 0);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(w_box, 0);
    ctx.lineTo(w_box, h_box);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(w_box, h_box);
    ctx.lineTo(w_offset, h_box);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(w_offset, h_box);
    ctx.lineTo(w_offset, 0);
    ctx.stroke();
    
    
    var num_checked = 0;
    for (var key in tissues){
        if (document.getElementById(tissues[key][3] + "_nsaf").checked) ++num_checked;
    }
    
    var j = 0;
    for (var key in tissues){
        if (document.getElementById(tissues[key][3] + "_nsaf").checked) add_nsaf(key, j++, num_checked, ctx);
    }
}

function add_nsaf(t, curr, total, ctx){
    
    var w_box = 600;
    var w_offset = 50;
    var h_box = 250;
    
    
    var nsaf_list = [];
    for (var prot_id in protein_dictionary){
        var protein = protein_dictionary[prot_id];
        if (t in protein.nsaf){
            nsaf_list.push(protein.nsaf[t]);
        }
    }
    nsaf_list.sort();
    
    var len = (w_box - 4 - w_offset) / total;
    var len_nsaf = nsaf_list.length;
    var start = curr * len;
    var curr_pos = len / len_nsaf;
    ctx.fillStyle = tissues[t][4];
    
    var nsaf_factor = (h_box - 4) / (max_NSAF - min_NSAF);
     
    var nsaf_set = new Set();
    for (var i = 0; i < nsaf_list.length; ++i){
        var nsaf = nsaf_list[i] - min_NSAF;
        nsaf *= nsaf_factor;
        nsaf = Math.floor(h_box - 2 - nsaf);
        var pos = Math.floor(w_offset + 2 + start + i * curr_pos);
        var hash = pos * h_box + nsaf;
        if (!nsaf_set.has(hash)){
            ctx.beginPath();
            ctx.arc(pos, nsaf, 1, 0, 2 * Math.PI);
            ctx.fill();
            nsaf_set.add(hash);
        }
    }
    
        
    ctx.font="14px Arial";
    var w = (w_box - w_offset) / total;
    ctx.save();
    ctx.translate(w_offset + (curr + 0.5) * w, h_box + 2);
    ctx.rotate(-Math.PI / 4);
    ctx.fillStyle = "black";
    ctx.textBaseline="middle";
    ctx.textAlign="right";
    ctx.fillText(tissues[t][1], 0, 8);
    ctx.restore();
}


function open_statistics (){
    document.getElementById("statistics").style.display = "inline";
    document.getElementById("click_background").style.display = "inline";
    background_hiding = hide_statistics;
    basket = {};
    spectra_exclude = [];
    
    // request proteins
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
            request_load_proteins(JSON.parse(xmlhttp.responseText), false);
            
            for (var t = 1; t <= 10; ++t){
                var sum_NSAF = 0;
                for (var prot_id in protein_dictionary){
                    var NSAF = 0;
                    var protein = protein_dictionary[prot_id];
                    for (var i = 0; i < protein.peptides.length; ++i){
                        var peptide = protein.peptides[i];
                        for (var j = 0; j < peptide.spectra.length; ++j){
                            var spectrum = peptide.spectra[j];
                            if (t in spectrum.tissues) NSAF += spectrum.tissues[t];
                            /*
                            if (min_ppm <= spectrum.ppm && spectrum.ppm < max_ppm){
                                ppm_histogram[Math.floor((spectrum.ppm - min_ppm) / ppm_steps)]++;
                            }
                            */                            
                        }
                    }
                    
                    NSAF /= protein.sequence_length;
                    if (NSAF > 0){
                        protein.nsaf[t] = NSAF;
                        sum_NSAF += NSAF;
                    }
                }
                
                for (var prot_id in protein_dictionary){
                    var protein = protein_dictionary[prot_id];
                    if (t in protein.nsaf){
                        protein.nsaf[t] = Math.log10(protein.nsaf[t] / sum_NSAF);
                        max_NSAF = Math.max(max_NSAF, protein.nsaf[t]);
                        min_NSAF = Math.min(min_NSAF, protein.nsaf[t]);
                    }
                    
                }
            }
            
            statistics_loaded++;
            update_nsaf();
            update_nsaf_pathway_figure();
            update_pI();
            update_ppm();
        }
    }
    
    xmlhttp.open("GET", "/qsdb/cgi-bin/get-proteins.bin?statistics&species=mouse", true);
    xmlhttp.send();
    
    var xmlhttp_search = new XMLHttpRequest();
    xmlhttp_search.onreadystatechange = function() {
        if (xmlhttp_search.readyState == 4 && xmlhttp_search.status == 200) {
            var tmp_pw = JSON.parse(xmlhttp_search.responseText);
            statistics_loaded++;
            
            for (var i = 0; i < tmp_pw.length; ++i){
                var pw_select = document.getElementById("nsaf_pathway_figure_select");
                var ppm_pw_select = document.getElementById("ppm_pw_figure_select");
                var new_option_nsaf = document.createElement("option");
                var new_option_ppm = document.createElement("option");
                new_option_nsaf.text = tmp_pw[i][1];
                new_option_ppm.text = tmp_pw[i][1];
                new_option_nsaf.id = tmp_pw[i][0];
                new_option_ppm.id = tmp_pw[i][0];
                pw_select.add(new_option_nsaf);
                ppm_pw_select.add(new_option_ppm);
                pathways_to_proteins[tmp_pw[i][0]] = [tmp_pw[i][1], tmp_pw[i][2]];
            }
            update_nsaf();
            update_nsaf_pathway_figure();
            update_pI();
            update_ppm();
        }
    }
    xmlhttp_search.open("GET", "/qsdb/cgi-bin/get-proteins.bin?statistics_pathways", true);
    xmlhttp_search.send();
}


function update_ppm(){
    if (statistics_loaded < 2) return;
    
    var pw_option = document.getElementById("ppm_pw_figure_select").options[document.getElementById("ppm_pw_figure_select").selectedIndex];
    
    
    var ppm_steps = 0.5;
    var min_ppm = -6 - ppm_steps / 2;
    var max_ppm = 6 + ppm_steps / 2;
    var num_bars = Math.floor((max_ppm - min_ppm) / ppm_steps);
            
    var ppm_histogram = new Array(num_bars).fill(0);
    var ppm_max_val = 0;
    
    
    var protein_ids = pathways_to_proteins[pw_option.id][1];
    var aaa = 0;
    var ttt = 0;
    for (var i = 0; i < protein_ids.length; ++i){
        var protein = protein_dictionary[protein_ids[i]];
        for (var j = 0; j < protein.peptides.length; ++j){
            var peptide = protein.peptides[j];
            for (var k = 0; k < peptide.spectra.length; ++k){
                ++aaa;
                var spectrum = peptide.spectra[k];
                if (min_ppm <= spectrum.ppm && spectrum.ppm < max_ppm){
                    ppm_histogram[Math.floor((spectrum.ppm - min_ppm) / ppm_steps)]++;
                }
            }
        }
    }
           
    var sum_ppm = 0;
    for (var i = 0; i < ppm_histogram.length; ++i){
        ppm_max_val = Math.max(ppm_histogram[i], ppm_max_val);
        sum_ppm += ppm_histogram[i];
    }
    
    var ppm_histogram_canvas = document.getElementById("ppm_histogram");
    var ppm_ctx = ppm_histogram_canvas.getContext("2d");
    ppm_ctx.clearRect(0, 0, ppm_histogram_canvas.width, ppm_histogram_canvas.height);
            
    var w_box = 600;
    var w_offset = 50;
    var h_box = 250;
    
    
    
    //scales
    // x-scale
    ppm_ctx.font="14px Arial";
    for (var i = Math.ceil(min_ppm); i < max_ppm; ++i){
        var x = w_offset + (i - min_ppm) / num_bars / ppm_steps * (w_box - w_offset);
        ppm_ctx.beginPath();
        ppm_ctx.moveTo(x, h_box - 5);
        ppm_ctx.lineTo(x, h_box + 5);
        ppm_ctx.stroke();
        ppm_ctx.fillStyle = "black";
        ppm_ctx.textBaseline="top";
        ppm_ctx.textAlign="center";
        ppm_ctx.fillText(i, x, h_box + 10);
    }
    // y-scale
    ppm_ctx.lineWidth = 1;
    ppm_ctx.textAlign="right";
    ppm_ctx.textBaseline="middle";
    var v_factor = 0.94;            
    var step = (ppm_max_val / sum_ppm) < 0.2 ? 2.5 : 10;
    ppm_ctx.font="14px Arial";
    
    var ppm_max_scale = ppm_max_val / sum_ppm * 100;
    for (var h = step; h <= ppm_max_scale; h += step){
        var y = h_box - (h / ppm_max_scale * h_box) * v_factor;
        ppm_ctx.strokeStyle = "#dddddd";
        ppm_ctx.beginPath();
        ppm_ctx.moveTo(w_offset, y);
        ppm_ctx.lineTo(w_box, y);
        ppm_ctx.stroke();
        
        ppm_ctx.strokeStyle = "black";
        ppm_ctx.beginPath();
        ppm_ctx.moveTo(w_offset - 5, y);
        ppm_ctx.lineTo(w_offset + 5, y);
        ppm_ctx.stroke();
        
        
        ppm_ctx.fillStyle = "black";
        ppm_ctx.fillText(h + "%", w_offset - 8, y);
    }

    ppm_ctx.beginPath();
    ppm_ctx.moveTo(w_offset, 0);
    ppm_ctx.lineTo(w_box, 0);
    ppm_ctx.stroke();
    
    ppm_ctx.beginPath();
    ppm_ctx.moveTo(w_box, 0);
    ppm_ctx.lineTo(w_box, h_box);
    ppm_ctx.stroke();
    
    ppm_ctx.beginPath();
    ppm_ctx.moveTo(w_box, h_box);
    ppm_ctx.lineTo(w_offset, h_box);
    ppm_ctx.stroke();
    
    ppm_ctx.beginPath();
    ppm_ctx.moveTo(w_offset, h_box);
    ppm_ctx.lineTo(w_offset, 0);
    ppm_ctx.stroke();
    
    
    ppm_ctx.fillStyle = "red";
    var bar_width = (w_box - w_offset - 2) / num_bars;
    for (var i = 0; i < ppm_histogram.length; ++i){
        var bar_y = h_box - 1 - (ppm_histogram[i] / ppm_max_val) * h_box * v_factor;
        var bar_height = h_box - bar_y;
        ppm_ctx.fillRect(w_offset + 1 + bar_width * i, bar_y, bar_width, bar_height);
    }
    ppm_ctx.fill();
    ppm_ctx.stroke();
    
    // axes labels
    ppm_ctx.fillStyle = "black";
    ppm_ctx.textAlign="center";
    ppm_ctx.fillText("Mass accuracy difference / ppm", (w_box + w_offset) / 2, h_box + 40);
    
}


function update_pI(){
    if (statistics_loaded < 2) return;

    var pI_figure = document.getElementById("pI_figure");
    var pI_ctx = pI_figure.getContext("2d");
    pI_ctx.clearRect(0, 0, nsaf_figure.width, nsaf_figure.height);
            
    var w_box = 590;
    var w_offset = 40;
    var w_bar = 30;
    var h_box = 250;

    pI_ctx.beginPath();
    pI_ctx.moveTo(w_offset, 0);
    pI_ctx.lineTo(w_box, 0);
    pI_ctx.stroke();
    
    pI_ctx.beginPath();
    pI_ctx.moveTo(w_box, 0);
    pI_ctx.lineTo(w_box, h_box);
    pI_ctx.stroke();
    
    pI_ctx.beginPath();
    pI_ctx.moveTo(w_box, h_box);
    pI_ctx.lineTo(w_offset, h_box);
    pI_ctx.stroke();
    
    pI_ctx.beginPath();
    pI_ctx.moveTo(w_offset, h_box);
    pI_ctx.lineTo(w_offset, 0);
    pI_ctx.stroke();
    
    var min_mass = 1000000;
    var max_mass = 0;
    
    for (var prot_id in protein_dictionary){
        var protein = protein_dictionary[prot_id];
        min_mass = Math.min(min_mass, Math.log10(protein.mass));
        max_mass = Math.max(max_mass, Math.log10(protein.mass));
    }
    
    
    var mass_factor = (h_box - 4) / (max_mass - min_mass);
    for (t in tissues){
        pI_ctx.fillStyle = tissues[t][4];
        if (document.getElementById(tissues[t][3] + "_pI").checked){
            for (var prot_id in protein_dictionary){
                var protein = protein_dictionary[prot_id];
                if (!(t in protein.nsaf)){
                    var log_mass = Math.log10(protein.mass) - min_mass;
                    log_mass *= mass_factor;
                    log_mass = h_box - 2 - log_mass;
                    
                    var pos = Math.floor(w_offset + 2 + (protein.pI - 2) / 12 * (w_box - w_offset - 2));
                    
                    pI_ctx.beginPath();
                    pI_ctx.arc(pos, log_mass, 1, 0, 2 * Math.PI);
                    pI_ctx.fill();
                }
            }
        }
    }
    
    // scale
    // x-scale
    pI_ctx.font="14px Arial";
    for (var i = 2; i <= 14; i += 2){
        var x = w_offset + (i - 2) / 12. * (w_box - w_offset);
        pI_ctx.beginPath();
        pI_ctx.moveTo(x, h_box - 5);
        pI_ctx.lineTo(x, h_box + 5);
        pI_ctx.stroke();
        pI_ctx.fillStyle = "black";
        pI_ctx.textBaseline="top";
        pI_ctx.textAlign="center";
        pI_ctx.fillText(i, x, h_box + 10);
    }
    // y-scale
    for (var i = Math.floor(min_mass); i < max_mass; ++i){
        var y = h_box - (i - min_mass) / (max_mass - min_mass) * h_box;
        pI_ctx.beginPath();
        pI_ctx.moveTo(w_offset - 5, y);
        pI_ctx.lineTo(w_offset + 5, y);
        pI_ctx.stroke();
        pI_ctx.fillStyle = "black";
        pI_ctx.textBaseline="middle";
        pI_ctx.textAlign="right";
        pI_ctx.fillText(i, w_offset - 10, y);
    }
}


function update_nsaf_pathway_figure(ctx){
    if (statistics_loaded < 2) return;
    var pw_option = document.getElementById("nsaf_pathway_figure_select").options[document.getElementById("nsaf_pathway_figure_select").selectedIndex];
    
    if (typeof(ctx) === 'undefined'){
        var nsaf_figure = document.getElementById("nsaf_pathway_figure");
        ctx = nsaf_figure.getContext("2d");
    }
            
    var w_box = 600;
    var w_offset = 50;
    var w_bar = 30;
    var h_box = 250;
    ctx.clearRect(0, 0, w_box, h_box);

    ctx.beginPath();
    ctx.moveTo(w_offset, 0);
    ctx.lineTo(w_box, 0);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(w_box, 0);
    ctx.lineTo(w_box, h_box);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(w_box, h_box);
    ctx.lineTo(w_offset, h_box);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(w_offset, h_box);
    ctx.lineTo(w_offset, 0);
    ctx.stroke();
    
    var protein_ids = pathways_to_proteins[pw_option.id][1];
    var tissue_nsafs = {};
    for (key in tissues) tissue_nsafs[key] = 0;
    var max_val = 0;
    for (var i = 0; i < protein_ids.length; ++i){
        var protein = protein_dictionary[protein_ids[i]];
        for (key in protein.nsaf){
            tissue_nsafs[key] += Math.pow(10, protein.nsaf[key]);
        }
    }
    
    var total = 0;
    for (t in tissue_nsafs){
        total += tissue_nsafs[t];
        max_val = Math.max(max_val, tissue_nsafs[t]);
    }
    
    
    ctx.lineWidth = 1;
    ctx.textAlign="right";
    //ctx.textBaseline="middle";
    var v_factor = 0.94;
    
    var step = 20;
    
    // y-scale
    ctx.font="14px Arial";
    for (var h = step; h <= 100; h += step){
        var y = h_box - (h / 100 * h_box) * v_factor;
        ctx.strokeStyle = "#dddddd";
        ctx.beginPath();
        ctx.moveTo(w_offset, y);
        ctx.lineTo(w_box, y);
        ctx.stroke();
        
        ctx.strokeStyle = "black";
        ctx.beginPath();
        ctx.moveTo(w_offset - 5, y);
        ctx.lineTo(w_offset + 5, y);
        ctx.stroke();
        
        
        ctx.fillStyle = "black";
        ctx.fillText(h + "%", w_offset - 8, y + 5);
    }
    
    var i = 0;
    var w = (w_box - w_offset) / 10;
    ctx.textAlign = 'right';
    for (t in tissue_nsafs){
        var x = Math.floor(w_offset + (i + 0.5) * w - w_bar * 0.5);
        var h = Math.floor(tissue_nsafs[t] / max_val * h_box * v_factor);
    
        ctx.fillStyle = tissues[t][4];
        ctx.fillRect(x, h_box - 1 - h, w_bar, h);
        ctx.fill();
        ctx.stroke();
        
        ctx.save();
        ctx.translate(w_offset + (i + 0.5) * w, h_box + 2);
        ctx.rotate(-Math.PI / 4);
        ctx.fillStyle = "black";
        ctx.fillText(tissues[t][1], 0, 8);
        ctx.restore();
        ++i;
    }
}

function hide_statistics (){
    document.getElementById("statistics").style.display = "none";
    document.getElementById("waiting_background").style.display = "none";
}


function open_disclaimer (){
    document.getElementById("disclaimer").style.display = "inline";
    document.getElementById("click_background").style.display = "inline";
    background_hiding = hide_disclaimer;
}

function hide_disclaimer (){
    document.getElementById("disclaimer").style.display = "none";
    document.getElementById("waiting_background").style.display = "none";
}


function change_chromosome_view(){
    var start_base = document.getElementById("chromosome_selection_start").value;
    start_base = replaceAll(start_base, " ", "");
    start_base = isNumber(start_base) ? parseInt(start_base) - 1 : 0;
    var end_base = document.getElementById("chromosome_selection_end").value;
    end_base = replaceAll(end_base, " ", "");
    end_base = isNumber(end_base) ? parseInt(end_base) : chromosomes[chromosome_selected].bases - 1;
    var diff_base = Math.max(1, end_base - start_base);
    
    start_base = Math.min(Math.max(0, start_base), chromosomes[chromosome_selected].bases - 1);
    diff_base = Math.min(Math.max(1, diff_base), chromosomes[chromosome_selected].bases - start_base);
    chromosomes[chromosome_selected].panel_base_start = start_base;
    chromosomes[chromosome_selected].panel_height = diff_base;
    
    for (var i = 0; i < chromosome_keys.length; ++i){
        var key = chromosome_keys[i];
        chromosomes[key].draw();
    }
    chromosome_selection_changed(true);
}


function change_chromosome_view_combo(){
    var opt = document.getElementById("chromosome_selection_combo");
    chromosome_selected = opt.options[opt.selectedIndex].value;
    
    for (var i = 0; i < chromosome_keys.length; ++i){
        var key = chromosome_keys[i];
        chromosomes[key].draw();
    }
    chromosome_selection_changed(true);    
}


if (!String.prototype.splice) {
    String.prototype.splice = function(start, newSubStr) {
        return this.slice(0, start) + newSubStr + this.slice(start);
    };
}


function add_numeric_separators(number){
    number = number.toString();
    if (number.length >= 16) number = number.splice(number.length - 15, " ");
    if (number.length >= 13) number = number.splice(number.length - 12, " ");
    if (number.length >= 10) number = number.splice(number.length - 9, " ");
    if (number.length >= 7) number = number.splice(number.length - 6, " ");
    if (number.length >= 4) number = number.splice(number.length - 3, " ");
    return number;
}


function toggle_chromosome_protein(protein_id){
    chromosome_data_dict[chromosome_selected][protein_id][9] = !chromosome_data_dict[chromosome_selected][protein_id][9];
}


function de_select_all_chromosome_proteins(to_select){
    for (var i = 0; i < currently_visible_proteins.length; ++i){
        currently_visible_proteins[i][9] = to_select;
    }
    chromosome_selection_changed(true);
}


function chromosome_selection_changed(content){
    if (loaded_chromosomes < chromosome_keys.length) return;
    
    if (chromosome_selected != -1){   
        currently_visible_proteins = [];
        var chrom_start = chromosomes[chromosome_selected].panel_base_start;
        var chrom_end = chrom_start + chromosomes[chromosome_selected].panel_height;
        var strt = add_numeric_separators(chrom_start + 1);
        var end = add_numeric_separators(chrom_end);
        document.getElementById("chromosome_selection_start").value = strt;
        document.getElementById("chromosome_selection_end").value = end;
        
        if (content){
            var chrm_dat = chromosome_data[chromosome_selected];
            var chr_tab_colors = ["#eeeeee", "#ffffff"];
            var chr_content = "<table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\"> \
            <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\">";
            for (var i = 0, j = 0; i < chrm_dat.length; ++i){
                var chr_strt = parseInt(chrm_dat[i][7]);
                if (chr_strt >= chrom_end) break;
                
                // filtern
                if (chr_strt >= chrom_start){
                    var checked = chrm_dat[i][9] ? "checked" : "";
                    chr_content += "<tr><td width=\"40%\" bgcolor=\"" + chr_tab_colors[j & 1] + "\">" + chrm_dat[i][5] + "</td><td width=\"50%\" bgcolor=\"" + chr_tab_colors[j & 1] + "\">" + chrm_dat[i][1] + "</td><td bgcolor=\"" + chr_tab_colors[j & 1] + "\" align=\"right\"><input type=\"checkbox\" " + checked + " onclick=\"toggle_chromosome_protein(" + chrm_dat[i][0] + ");\"></td></tr>";
                    currently_visible_proteins.push(chrm_dat[i]);
                    j += 1;
                }
            }
            chr_content += "</table>";
            document.getElementById("chromosome_information_table").innerHTML = chr_content;
        }
    }
}


function Chromosome(name, data, ctx, chromosome_width, chromosome_height){
    this.name = name;
    this.bands = [];
    this.width = chromosome_width;
    this.inner_width = chromosome_width * 2 / 3;
    this.margin = (this.width - this.inner_width) / 2;
    this.height = chromosome_height;
    this.inner_height = this.height;
    this.panel_base_start = 0;
    this.panel_move = -1;
    this.panel_move_start = -1;
    this.offset = 0;
    this.ctx = ctx;
    this.bases = 0;
    for (var i = 0; i < data.length; ++i) this.bands.push(new Band(data[i]));
    this.bands.sort(function(a, b){return a.start - b.start});
    for (var i = 0; i < this.bands.length; ++i) this.bases += this.bands[i].end - this.bands[i].start;
    this.panel_height = Math.min(20000000, this.bases);
    
    
    this.prepare_modification = function(){}
    
    this.draw = function(){
        ctx.canvas.width  = this.width;
        ctx.canvas.height = this.height;
        ctx.beginPath();
        var len = this.bands.length;


        var grd_white = ctx.createLinearGradient(0, 0, this.width, 0);
        grd_white.addColorStop(0, "#a09a85");
        grd_white.addColorStop(0.3, "#fff6d5");
        grd_white.addColorStop(1, "#a09a85");


        var has_two_arms = -1;
        var band_height = 0;
        for (var i = 0; i < len; ++i){
            var curr_height = (this.bands[i].end - this.bands[i].start) / this.bases * this.inner_height;
            this.bands[i].height = curr_height;
            band_height += curr_height;
            if (i < len - 1 && this.bands[i].arm != this.bands[i + 1].arm) has_two_arms = band_height;
        }
        
        

        
        ctx.save();
        band_height = 0;
        // prepare clip
        var l_1 = this.inner_width / 2
        var l_2 = this.margin + l_1;
        if (has_two_arms == -1){
            ctx.beginPath();
            ctx.arc(l_2, this.offset + l_1, l_1, Math.PI, 2 * Math.PI, false);
            ctx.arc(l_2, this.height - l_1, l_1, 0, Math.PI, false);
            ctx.closePath();
        }
        else {
            ctx.beginPath();
            ctx.arc(l_2, this.offset + l_1, l_1, Math.PI, 2 * Math.PI, false);
            ctx.arc(l_2, this.offset + has_two_arms - l_1, l_1, 0, Math.PI, false);
            ctx.arc(l_2, this.offset + has_two_arms + l_1, l_1, Math.PI, 2 * Math.PI, false);
            ctx.arc(l_2, this.height - l_1, l_1, 0, Math.PI, false);
            ctx.closePath();
        }
        ctx.clip();
        ctx.fillRect(0, this.offset, this.width, this.inner_height);
        ctx.restore();
        
        
        ctx.shadowColor = '#666666';
        ctx.shadowBlur = 5;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = -2;
        ctx.fill();

        
       
        ctx.save();
        // prepare clip
        band_height = 0;
        var l_1 = this.inner_width / 2
        var l_2 = this.margin + l_1;
        if (has_two_arms == -1){
            ctx.beginPath();
            ctx.arc(l_2, this.offset + l_1, l_1, Math.PI, 2 * Math.PI, false);
            ctx.arc(l_2, this.height - l_1, l_1, 0, Math.PI, false);
            ctx.closePath();
        }
        else {
            ctx.beginPath();
            ctx.arc(l_2, this.offset + l_1, l_1, Math.PI, 2 * Math.PI, false);
            ctx.arc(l_2, this.offset + has_two_arms - l_1, l_1, 0, Math.PI, false);
            ctx.arc(l_2, this.offset + has_two_arms + l_1, l_1, Math.PI, 2 * Math.PI, false);
            ctx.arc(l_2, this.height - l_1, l_1, 0, Math.PI, false);
            ctx.closePath();
        }
        ctx.clip();

        // draw bands
        var band_height = 0;
        for (var i = 0; i < len; ++i){
            var curr_height = this.bands[i].height;
            if (this.bands[i].positive == 1){
                var grd = ctx.createLinearGradient(0, 0, this.width, 0);
                grd.addColorStop(0, "rgb(" + Math.floor(64 + (255 - 150) * (1 - this.bands[i].color)).toString() + ", 0, 0)");
                grd.addColorStop(0.3, "rgb(" + Math.floor(150 + (255 - 150) * (1 - this.bands[i].color)).toString() + ", 0, 0)");
                grd.addColorStop(1, "rgb(" + Math.floor(20 + (255 - 150) * (1 - this.bands[i].color)).toString() + ", 0, 0)");
                ctx.fillStyle = grd;
            }
            else {
                ctx.fillStyle = grd_white;
            }
            ctx.fillRect(0, this.offset + band_height, this.width, this.offset + band_height + curr_height);
            band_height += curr_height;
        }
        ctx.restore();
        
        
    
        // draw panel
        if (chromosome_selected == this.name){
            ctx.fillStyle = "rgba(100, 100, 100, 0.5)";
            var h_start = Math.floor(this.offset + this.panel_base_start / this.bases * this.inner_height);
            var h_base = Math.floor(this.panel_height / this.bases * this.inner_height);
            ctx.fillRect(0, h_start, this.width, h_base);
        }
        
    } 
    
    this.clicked = function(e, mouse_pos){
        // check where the panel was clicked
        if (mouse_pos.y < this.offset) return;
        if (!(chromosome_selected == this.name) || !this.mouse_over_panel(e, mouse_pos)){
            this.panel_base_start = Math.floor((mouse_pos.y - this.offset) / this.inner_height * this.bases - this.panel_height / 2);
            this.panel_base_start = Math.max(0, this.panel_base_start);
            this.panel_base_start = Math.min(this.panel_base_start, this.bases - this.panel_height);
        }
        
        chromosome_selection_changed(true);
        this.draw();
    }
    
    this.mouse_over_panel = function(e, mouse_pos){
        var h_start = Math.floor(this.offset + this.panel_base_start / this.bases * this.inner_height);
        var h_base = Math.floor(this.panel_height / this.bases * this.inner_height);
        return (h_start <= mouse_pos.y && mouse_pos.y <= h_start + h_base);
    }

    this.mouse_down = function(e, mouse_pos, rect){
        if (!(chromosome_selected == this.name) || !this.mouse_over_panel(e, mouse_pos)) return;
        var h_start = Math.floor(this.panel_base_start / this.bases * this.inner_height);
        this.panel_move = mouse_pos.y + rect.top;
        this.panel_move_start = h_start;
    }

    this.mouse_up = function(e){
        if (this.panel_move != -1) chromosome_selection_changed(true);
        this.panel_move = -1;
    }

    this.mouse_move = function(e, mouse_pos){
        if (this.panel_move != -1){
            this.panel_base_start = Math.floor((mouse_pos.y - this.panel_move + this.panel_move_start) / this.inner_height * this.bases);
            this.panel_base_start = Math.max(0, this.panel_base_start);
            this.panel_base_start = Math.min(this.panel_base_start, this.bases - this.panel_height);
            chromosome_selection_changed(false);
            this.draw();
        }
    }

    this.mouse_wheel = function(e, mouse_pos, rect){
        var ft = 5000000;
        
        if (chromosome_selected == this.name){
            var diff = ft * (e.detail < 0 ? 1 : -1);
            if (this.panel_height + diff >= 10000000){
                this.panel_base_start -= Math.floor(ft / 2 * (e.detail < 0 ? 1 : -1));
            }
            this.panel_height += Math.floor(ft * (e.detail < 0 ? 1 : -1));
            this.panel_height = Math.max(10000000, this.panel_height);
            this.panel_height = Math.min(this.bases, this.panel_height);
            
            
            if (this.panel_base_start < 0) this.panel_base_start = 0;
            if (this.panel_base_start + this.panel_height >= this.bases) this.panel_base_start = Math.floor(this.bases - this.panel_height);
            chromosome_selection_changed(true);
            this.draw();
        }
    }
}


function chromosome_clicked(e){
    var old_key = chromosome_selected;
    chromosome_selected = e.target.id.replace("chromosome-", "");
    
    chromosomes[chromosome_selected].clicked(e, get_mouse_pos(e.target, e));
    
    var opt = document.getElementById("chromosome_selection_combo");
    for (var i = 0; i < opt.options.length; ++i){
        if (opt.options[i].value == chromosome_selected){
            opt.options[i].selected = true;
            break;
        }
    }
    
    chromosomes[old_key].draw();
    chromosomes[chromosome_selected].draw();
}


function chromosome_mousedown(e){
    var mouse_pos = get_mouse_pos(e.target, e);
    var key = e.target.id.replace("chromosome-", "");
    chromosomes[key].mouse_down(e, mouse_pos, e.target.getBoundingClientRect());
}


function chromosome_mousemove(e){
    var mouse_pos = { x: e.clientX, y: e.clientY};
    if (chromosome_selected in chromosomes) chromosomes[chromosome_selected].mouse_move(e, mouse_pos);
}


function chromosome_mouseup(e){
    for (var i = 0; i < chromosome_keys.length; ++i){
        var key = chromosome_keys[i];
        chromosomes[key].mouse_up(e);
    }
}

function chromosome_mouse_wheel(e){
    for (var i = 0; i < chromosome_keys.length; ++i){
        var key = chromosome_keys[i];
        chromosomes[key].mouse_wheel(e);
    }
}


var chromosome_width = 30;
var chromosome_height = 500;
var ideom_data = "";
chroms = document.getElementById("function_chromosome_field");
chroms.innerHTML = "";



// tpyes 0: accession, 1: locus, 2: function, 3: chromosome
function check_filter_valid(filter_type){

    var selected_functions = false;
    var chromosomes_selected_protein = false;
    if (filter_type == 1){
        var loci_select = document.getElementById("loci");
        for (var i = 0; i < loci_select.options.length; ++i){
            if (loci_select.options[i].selected){
                selected_functions = true;
                break;
            }
        }
    }
    else if (filter_type == 3){
        for (var chromosome_key in chromosome_data){
            for (var i = 0; i < chromosome_data[chromosome_key].length; ++i){
                if (chromosome_data[chromosome_key][i][9]){
                    chromosomes_selected_protein = true;
                    break;
                }
            }
        }
    }
    
    if (filter_type == 0 && document.getElementById("accessions").value.length == 0){
        document.getElementById("error_filter_text_accession").innerHTML = "Error: no accession number provided!";
    }
    else if (filter_type == 1 && !selected_functions){
        document.getElementById("error_filter_text_locus").innerHTML = "Error: no compartment selected!";
    }
    else if (filter_type == 3 && !chromosomes_selected_protein){
        document.getElementById("error_filter_text_chromosome").innerHTML = "Error: no protein selected!";
    }
    else {
        switch (filter_type){
            case 0:
                back_function = open_accession_search;
                hide_accession_search(true);
                accession_search_parse_accessions();
                break;
                
            case 1:
                back_function = open_locus_search;
                hide_locus_search(true);
                locus_search_request_data();
                break;
                
            case 2:
                back_function = open_function_search;
                hide_function_search(true);
                function_search_request_data();
                break;
                
            case 3:
                back_function = open_chromosome_search;
                hide_chromosome_search(true);
                chromosome_search_request_data();
                break;
        }
    }
}


function activateTree(oList) {
    // Collapse the tree
    for (var i = 0; i < oList.getElementsByTagName("ul").length; ++i) {
        oList.getElementsByTagName("ul")[i].style.display = "none";
    }
    for (var i = 0; i < oList.getElementsByTagName("li").length; ++i) {
        if (oList.getElementsByTagName("li")[i].getElementsByTagName("ul").length > 0){
            oList.getElementsByTagName("li")[i].style.fontWeight = "bold";
            oList.getElementsByTagName("li")[i].className = "collapsed";
        }
        else {
            oList.getElementsByTagName("li")[i].style.fontWeight = "normal";
            oList.getElementsByTagName("li")[i].className = "empty";
        }
    }
    // Add the click-event handler to the list items
    if (oList.addEventListener) {
        oList.addEventListener("click", toggleBranch, false);
    } else if (oList.attachEvent) { // For IE
        oList.attachEvent("onclick", toggleBranch);
    }
}


function toggleBranch(event) {
    var oBranch, cSubBranches;
    if (event.target) {
        oBranch = event.target;
    } else if (event.srcElement) { // For IE
        oBranch = event.srcElement;
    }
    cSubBranches = oBranch.getElementsByTagName("ul");
    if (cSubBranches.length > 0) {
        if (cSubBranches[0].style.display == "block") {
            cSubBranches[0].style.display = "none";
            oBranch.className = "collapsed";
            
        } else {
            cSubBranches[0].style.display = "block";
            oBranch.className = "expanded";
        }
    }
    else {
        if (oBranch.style.backgroundColor == ""){
            oBranch.style.backgroundColor = "#4a79ba";
            oBranch.style.color = "#ffffff";
        }
        else {
            oBranch.style.backgroundColor = "";
            oBranch.style.color = "#000000";
        }
    }
}


function recursive_list_adding(function_tree){
    var ret_text = "";
    for (var i = 0; i < function_tree.length; ++i){
        if (function_tree[i][3].length > 0 || function_tree[i][2] > 0){
            ret_text += "<li id=\"" + function_tree[i][0] + "\">" + function_tree[i][1];
            if (function_tree[i][3].length > 0) ret_text += "<ul>" + recursive_list_adding(function_tree[i][3]) + "</ul>";
            else ret_text += " (" + function_tree[i][2] + ")";
            ret_text += "</li>";
        }
    }
    return ret_text;
}


function advanced_search_init(){
    window.addEventListener('resize', resize_ms_view, false);
    document.getElementById("msarea").addEventListener("mousewheel", view_mouse_wheel_listener, false);
    document.getElementById("msarea").addEventListener('DOMMouseScroll', view_mouse_wheel_listener, false);
}


function key_down(event){
    if (event.which === 17){ // CTRL
        //pathway_to_svg();
        nsaf_to_svg();
    }    


    // easter egg
    var k_code = [75, 78, 73, 71, 72, 84, 82, 73, 68, 69, 82];
    
    kr_keys.push(event.which);
    while (kr_keys.length > 11) kr_keys.shift();
    if (kr_keys.length == 11){
        var k_is_valid = true;
        for (var i = 0; i < 11; ++i){
            if (k_code[i] != kr_keys[i]){
                k_is_valid = false;
                break;
            }
        }
        if (k_is_valid){
            scanner_data = [1, 0, 0];
            
            var scanner_light = setInterval(function(scanner_data, nav_ids){
                for (var i = 0; i < nav_ids.length; ++i){
                    document.getElementById(nav_ids[i]).style.backgroundColor = "";
                }
                document.getElementById(nav_ids[scanner_data[1]]).style.backgroundColor = "#a20000";
                
                if (scanner_data[0] == -1 && scanner_data[1] == 0) scanner_data[0] = 1;
                if (scanner_data[0] == 1 && scanner_data[1] == 7) scanner_data[0] = -1;
                scanner_data[1] += scanner_data[0];
                
                if (scanner_data[2] % 15 == 0){
                    var audio = document.getElementsByTagName("audio")[0];
                    audio.currentTime = 0;
                    audio.play();
                }
                scanner_data[2] += 1;
                
                if (scanner_data[2] >= 43){
                    for (var i = 0; i < nav_ids.length; ++i){
                        document.getElementById(nav_ids[i]).style.backgroundColor = "";
                    }
                    clearInterval(scanner_light);
                }
            }, 80, scanner_data, nav_ids);
        }
    }    
}


// function for loading chromosome, loci, functions data
function load_all_data(){
    // get functions
    var xmlhttpfunctions = new XMLHttpRequest();
    xmlhttpfunctions.onreadystatechange = function() {
        if (xmlhttpfunctions.readyState == 4 && xmlhttpfunctions.status == 200) {
            var function_data = JSON.parse(xmlhttpfunctions.responseText);
            var id_dict = {};
            var function_tree = [];
            
            for (var i = 0; i < function_data.length; ++i){
                var function_row = function_data[i];
                if (function_row[2] == 0){
                    function_tree = [function_row[0], function_row[1], function_row[3], []];
                    id_dict[function_row[0]] = function_tree;
                    continue;
                }
                if (function_row[2] in id_dict){
                    var node = [function_row[0], function_row[1], function_row[3], []];
                    id_dict[function_row[2]][3].push(node);
                    id_dict[function_row[0]] = node;
                }
                else {
                    console.log("Error while loading functions, index " + function_row[2] + " is missing!");
                    return;
                }
            }
            
            var functions_tree_content = "<ul id=\"LinkedList1\" class=\"LinkedList\" style=\"padding-left:0;\">";
            functions_tree_content += recursive_list_adding(function_tree[3]);
            functions_tree_content += "</ul>";
            document.getElementById("function_search_field").innerHTML = functions_tree_content;
            activateTree(document.getElementById("LinkedList1"));
        }
    }
    xmlhttpfunctions.open("GET", "/qsdb/cgi-bin/get-functions.py", true);
    xmlhttpfunctions.send();
    
    
    // get loci
    var xmlhttploci = new XMLHttpRequest();
    xmlhttploci.onreadystatechange = function() {
        if (xmlhttploci.readyState == 4 && xmlhttploci.status == 200) {
            var locus_data = JSON.parse(xmlhttploci.responseText);
            var locus_select = document.getElementById("loci");
            for (var i = 0; i < locus_data.length; ++i){
                var option = document.createElement("option");
                option.text = locus_data[i][1];
                option.id = locus_data[i][0];
                locus_select.add(option);
            }
        }
    }
    xmlhttploci.open("GET", "/qsdb/cgi-bin/get-loci.py", true);
    xmlhttploci.send();
    
    
    // get chromosome bands
    var xmlhttp_chr = new XMLHttpRequest();
    xmlhttp_chr.onreadystatechange = function() {
        if (xmlhttp_chr.readyState == 4 && xmlhttp_chr.status == 200) {
            ideom_data = JSON.parse(xmlhttp_chr.responseText);
        }
    }
    xmlhttp_chr.open("GET", "/qsdb/cgi-bin/get-chromosomes.py?species=mouse", true);
    xmlhttp_chr.send();
    
    // load tissue images
    for (var key in tissues){
        tissue = tissues[key];
        tissue[2] = new Image();
        tissue[2].src = tissue[0];
    }
}
load_all_data();


function draw_chromosome_ideograms(){
    var max_bases = 0;
    chromosome_keys = Object.keys(ideom_data);
    var max_len = 0;
    for (var i = 0; i < chromosome_keys.length; ++i){
        chromosome_keys[i] = [chromosome_keys[i], chromosome_keys[i]];
        max_len = Math.max(chromosome_keys[i].length, max_len);
    }
    
    
    for (var i = 0; i < chromosome_keys.length; ++i){
        while (chromosome_keys[i][1].length < max_len && 48 <= chromosome_keys[i][1].charCodeAt(0) && chromosome_keys[i][1].charCodeAt(0) < 58){
            chromosome_keys[i][1] = "0" + chromosome_keys[i][1];
        }
    }
    
    chromosome_keys.sort(function(a, b){return a[1].localeCompare(b[1]);});
    var chr_tmp = chromosome_keys;
    chromosome_keys = [];
    for (var i = 0; i < chr_tmp.length; ++i) chromosome_keys.push(chr_tmp[i][0]);
    

    var chroms_innerHTML = "";
    chroms_innerHTML += "<table width=\"100%\" border=0 cellspacing=0 cellpadding=0><tr>";
    for (var i = 0; i < chromosome_keys.length; ++i){
        chroms_innerHTML += "<td align=\"center\"><canvas id=\"chromosome-" + chromosome_keys[i] + "\">Your browser does not support the HTML5 canvas tag.</canvas></td>";
        chromosome_map["chromosome-" + chromosome_keys[i]] = i;
    }
    chroms_innerHTML += "</tr></table>";
    chroms.innerHTML = chroms_innerHTML;
    
    for (var i = 0; i < chromosome_keys.length; ++i){
        var key = chromosome_keys[i];
        var chrm = document.getElementById("chromosome-" + key);
        var new_chromosome = new Chromosome(key, ideom_data[key], chrm.getContext("2d"), chromosome_width, chromosome_height);
        chromosomes[key] = new_chromosome;
        max_bases = Math.max(max_bases, new_chromosome.bases);
        
        chrm.addEventListener("click", chromosome_clicked, false);
        chrm.addEventListener("mousedown", chromosome_mousedown, false);
    }
    for (var i = 0; i < chromosome_keys.length; ++i){
        var key = chromosome_keys[i];
        chromosomes[key].offset = Math.min(chromosome_height * (1 - chromosomes[key].bases / max_bases), chromosome_height - chromosome_width);
        chromosomes[key].inner_height = chromosomes[key].height - chromosomes[key].offset;
    }
    for (var i = 0; i < chromosome_keys.length; ++i){
        var key = chromosome_keys[i];
        chromosomes[key].draw();
        var option = document.createElement("option");
        option.text = key;
        document.getElementById("chromosome_selection_combo").add(option); 
    }
    
    if (chromosome_selected == -1){
        chromosome_selected = chromosome_keys[0];
    }
    
    
    // get chromosome data
    var chromosome_requests = {};
    for (var i = 0; i < chromosome_keys.length; ++i){
        var key = chromosome_keys[i];
        chromosome_requests[key] = new XMLHttpRequest();
        chromosome_requests[key].chromosome_key = key;
        chromosome_requests[key].onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var input_dat = JSON.parse(this.responseText);
                chromosome_data[this.chromosome_key] = input_dat;
                chromosome_data_dict[this.chromosome_key] = {};
                var chrm_dat_dict = chromosome_data_dict[this.chromosome_key];
                
                for (var i = 0; i < input_dat.length; ++i){
                    input_dat[i].push(false);
                    chrm_dat_dict[input_dat[i][0]] = input_dat[i];
                }
                
                
                loaded_chromosomes += 1;
                chromosome_selection_changed(true);
                chromosomes[this.chromosome_key].draw();
            }
        }
        chromosome_requests[key].open("GET", "/qsdb/cgi-bin/get-chromosome-data.py?chromosome=" + key + "&species=mouse", true);
        chromosome_requests[key].send();
    }
}


function nsaf_pathway_to_svg(){
    if (statistics_loaded < 2) return;
    
    var svg_ctx = new C2S(600, 300);
    update_nsaf_pathway_figure(svg_ctx);
    
    var svgCode = svg_ctx.getSerializedSvg(true);
    var parts = svgCode.split("/>");
    svgCode = parts.join("/>\n");
    
    window.open("data:application/txt," + encodeURIComponent(svgCode), "_self");
}



function nsaf_to_svg(){
    if (statistics_loaded < 2) return;
    
    var svg_ctx = new C2S(600, 300);
    update_nsaf(svg_ctx);
    
    var svgCode = svg_ctx.getSerializedSvg(true);
    var parts = svgCode.split("/>");
    svgCode = parts.join("/>\n");
    
    window.open("data:application/txt," + encodeURIComponent(svgCode), "_self");
}



var kr_keys = [];
var scanner_data = [1, 0, 0]; // scanner_up, scanner_index, scanner_count
var nav_ids = ["how_to_nav", "pathway_browser_nav", "subcellular_search_nav", "functional_search_nav", "accession_search_nav", "chromosome_search_nav", "statistics_nav", "about_nav"];
document.addEventListener('keydown', key_down, false);
document.addEventListener("mousemove", chromosome_mousemove, false);
document.addEventListener("mouseup", chromosome_mouseup, false);
document.getElementById("function_chromosome_field").addEventListener('DOMMouseScroll', chromosome_mouse_wheel, false);
document.getElementById("click_background").addEventListener("click", hide_background, false);
document.getElementById("check_spectra").innerHTML = get_check_spectra_content();
document.getElementById("waiting_background").innerHTML = get_waiting_background_content();

</script>
</html> 
